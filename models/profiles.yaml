models:
  - name: users_stitcher
    model_type: id_stitcher
    model_spec:
      validity_time: 24h # 1 day
      entity_key: user
      edge_sources:
        - from: inputs/rsIdentifies
        - from: inputs/rsTracks
        - from: inputs/rsPages
  # Remove the section below, if you don't want to generate a feature table
  - name: users
    model_type: feature_table_model
    model_spec:
      validity_time: 24h # 1 day
      entity_key: user
      features:
        - titles_watched
        - unique_titles_watched
        - total_episodes_watched
        - total_movies_rented
        - vikipass_trial_completed
        - ltv
        - churn_prediction_score
        - most_recent_email
        - first_name
        - last_name
        - total_sessions_to_date
var_groups:
  - name: user_vars
    entity_key: user
    vars:
      - entity_var:
          name: titles_watched
          from: inputs/rsIdentifies
          select: array_agg(array_construct('love song for illusion','the innocent man','perfect marriage revenge', 'yong an dream')[ABS(MOD(Random(),4))]::text)
          description: All unique shows viewed
      - entity_var:
          name: unique_titles_watched
          from: inputs/rsIdentifies
          select: first_value(number ignore nulls)
          window:
            order_by:
              - timestamp desc
          description: Number of unique shows viewed
      - entity_var:
          name: total_episodes_watched
          from: inputs/rsIdentifies
          select: sum(number::real)
          description: Number of episodes watched in total
      - entity_var:
          name: total_movies_rented
          from: inputs/rsIdentifies
          select: first_value(movies_rented ignore nulls)
          window:
            order_by:
              - timestamp desc
          description: Number of movies rented
      - entity_var:
          name: vikipass_trial_completed
          from: inputs/rsIdentifies
          select: round(right(random(), 1)/10)
          description: Has the user completed a vikipass trial?
      - entity_var:
          name: ltv
          from: inputs/rsIdentifies
          select: uniform(1, 100, random())
          description: User LTV
      - entity_var:
          name: churn_prediction_score
          from: inputs/rsIdentifies
          select: first_value(churn_score ignore nulls)
          window:
            order_by:
              - timestamp desc
          description: The churn prediction score based on past activity
      - entity_var:
          name: total_sessions_to_date
          from: models/rsTracksUnionPages
          select: count(distinct context_session_id)
          where: context_session_id is not null
          description: Total individual sessions created till date.
      - entity_var:
          name: first_name
          from: inputs/rsIdentifies
          select: first_value(first_name ignore nulls)
          window:
            order_by:
              - timestamp desc
          where: first_name is not null and first_name!=''
          description: First name of the customer
      - entity_var:
          name: last_name
          from: inputs/rsIdentifies
          select: first_value(last_name ignore nulls)
          window:
            order_by:
              - timestamp desc
          where: last_name is not null and last_name!=''
          description: Last name of the customer
      - entity_var:
          name: most_recent_email
          from: inputs/rsIdentifies
          select: first_value(email)
          window:
            order_by:
              - timestamp desc
          where: email is not null and email!=''
          description: Email associated to the order
